<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Lechelle Covoit</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --accent: #007aff; --bg: #f5f5f7; --gray: #8e8e93; }
        body { margin: 0; font-family: -apple-system, sans-serif; background: var(--bg); color: #1d1d1f; }
        
        /* Navigation & Animation */
        .nav { background: white; padding: 15px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 1000; }
        .logo-box { display: flex; align-items: center; gap: 10px; }
        .car-track { position: relative; width: 40px; height: 24px; overflow: hidden; background: #eee; border-radius: 12px; }
        .driving-car { position: absolute; font-size: 1.2rem; animation: driveVanish 3s linear infinite; }
        @keyframes driveVanish {
            0% { transform: translateX(40px); opacity: 1; }
            80% { opacity: 1; }
            100% { transform: translateX(-40px); opacity: 0; }
        }

        .container { max-width: 1100px; margin: 0 auto; padding: 0 20px; }
        .hero { background: linear-gradient(rgba(0,122,255,0.8), rgba(0,122,255,0.6)), url('https://images.unsplash.com/photo-1449965408869-eaa3f722e40d?auto=format&fit=crop&w=1000&q=80') center/cover; color: white; padding: 60px 20px; text-align: center; }
        
        /* Cards & Grid */
        .ride-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; margin: 30px 0; }
        .card { background: white; border-radius: 18px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.08); transition: transform 0.2s; position: relative; }
        .full-ride { filter: grayscale(0.4); opacity: 0.9; }
        .badge-full { position: absolute; top: 10px; right: 10px; background: var(--gray); color: white; padding: 4px 10px; border-radius: 6px; font-size: 0.7em; font-weight: bold; z-index: 10; }

        /* Buttons & Forms */
        .btn { padding: 10px 18px; border-radius: 10px; font-weight: 600; cursor: pointer; text-decoration: none; display: inline-block; border: none; font-size: 0.9em; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-wait { background: #e5e5ea; color: #3a3a3c; }
        input { padding: 12px; border: 1px solid #ddd; border-radius: 10px; outline: none; }
    </style>
</head>
<body>
    <div class="nav">
        <div class="container" style="display:flex; justify-content:space-between; align-items:center;">
            <div class="logo-box">
                <div class="car-track"><span class="driving-car">ðŸš—</span></div>
                <strong style="font-size: 1.2em;">Lechelle Covoit</strong>
            </div>
            <div>
                {% if current_user.is_authenticated %}
                    <a href="/my-account" style="margin-right:15px; text-decoration:none; color:var(--accent); font-weight:500;">Historique</a>
                    <span>{{ current_user.name }}{% if current_user.is_admin %} (Admin){% endif %}</span> | <a href="/logout">Quitter</a>
                {% else %}
                    <a href="/login" style="text-decoration:none; color:var(--accent);">Connexion</a> | <a href="/signup" style="text-decoration:none; color:var(--accent);">S'inscrire</a>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="hero">
        <h1>Voyagez ensemble Ã  Lechelle</h1>
        <p>Le covoiturage solidaire, gratuit et sans frais.</p>
    </div>

    <div class="container">
        {% if current_user.is_authenticated %}
        <div style="background:white; padding:25px; border-radius:18px; margin: 40px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
            <h3 style="margin-top:0;">Proposer un trajet</h3>
            <form action="/publish" method="post" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(140px, 1fr)); gap:10px;">
                <input name="departure" placeholder="DÃ©part (ex: Lechelle)" required>
                <input name="destination" placeholder="Destination" required>
                <input name="contact" placeholder="TÃ©l / WhatsApp" required>
                <input type="date" name="date" required>
                <input type="time" name="time" required>
                <input type="number" name="seats" placeholder="Places" min="1" required>
                <button type="submit" class="btn btn-primary">Publier</button>
            </form>
        </div>
        {% endif %}

        <h2>Trajets Ã  venir</h2>
        <div class="ride-grid">
            {% for r in rides %}
            <div class="card {{ 'full-ride' if r.seats == 0 else '' }}">
                {% if r.seats == 0 %}<div class="badge-full">COMPLET</div>{% endif %}
                <div id="map_{{ r.id }}" style="height:150px;" data-dep="{{ r.departure }}" data-dest="{{ r.destination }}"></div>
                <div style="padding:15px;">
                    <strong style="font-size:1.1em;">{{ r.departure }} âž” {{ r.destination }}</strong><br>
                    <small style="color:#666;">{{ r.date }} Ã  {{ r.time }} | Par: {{ r.driver_name }}</small>
                    
                    <div style="margin-top:15px; display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-weight:600; color:{{ 'var(--gray)' if r.seats == 0 else 'green' }};">ðŸ’º {{ r.seats }} places</span>
                        <div style="display:flex; align-items:center; gap:8px;">
                            {% if current_user.is_authenticated and current_user.id != r.user_id %}
                                {% if r.seats > 0 %}
                                    <a href="{{ url_for('reserve', ride_id=r.id) }}" class="btn btn-primary">RÃ©server</a>
                                {% else %}
                                    <a href="{{ url_for('reserve', ride_id=r.id) }}" class="btn btn-wait">Attente</a>
                                {% endif %}
                            {% endif %}
                            
                            {% if current_user.is_admin or (current_user.is_authenticated and current_user.id == r.user_id) %}
                                <a href="{{ url_for('delete_ride', ride_id=r.id) }}" onclick="return confirm('Archiver ce trajet ?')" style="text-decoration:none; color:red; font-size:1.2em;">ðŸ—‘</a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
                <p style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--gray);">Aucun trajet actif pour le moment.</p>
            {% endfor %}
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        async function geocode(city) {
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)}&limit=1`);
                const data = await res.json();
                return data.length > 0 ? [parseFloat(data[0].lat), parseFloat(data[0].lon)] : null;
            } catch { return null; }
        }
        async function initMaps() {
            for (let el of document.querySelectorAll('[id^="map_"]')) {
                const dep = await geocode(el.dataset.dep);
                const dest = await geocode(el.dataset.dest);
                if (dep && dest) {
                    const map = L.map(el.id, {zoomControl: false, attributionControl: false}).setView(dep, 10);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                    L.polyline([dep, dest], {color: '#007aff', weight: 4}).addTo(map);
                    L.circleMarker(dep, {radius: 5, color: 'blue'}).addTo(map);
                    L.circleMarker(dest, {radius: 5, color: 'red'}).addTo(map);
                }
            }
        }
        window.onload = initMaps;
    </script>
</body>
</html>