<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Lechelle Covoit</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --accent: #007aff; --bg: #f5f5f7; --gray: #8e8e93; }
        body { margin: 0; font-family: -apple-system, sans-serif; background: var(--bg); color: #1d1d1f; }
        
        .nav { background: white; padding: 15px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 1000; }
        .logo-box { display: flex; align-items: center; gap: 10px; }
        .car-track { position: relative; width: 40px; height: 24px; overflow: hidden; background: #eee; border-radius: 12px; }
        .driving-car { position: absolute; font-size: 1.2rem; animation: driveVanish 3s linear infinite; }
        @keyframes driveVanish { 0% { transform: translateX(40px); } 100% { transform: translateX(-40px); } }

        .hero { 
            background: linear-gradient(rgba(0,122,255,0.7), rgba(0,122,255,0.5)), 
                        url("{{ url_for('static', filename='carte-postale-ancienne-lechelle-20_0.jpg') }}") center/cover; 
            color: white; padding: 80px 20px; text-align: center; border-radius: 0 0 30px 30px; 
        }

        .container { max-width: 1100px; margin: 0 auto; padding: 0 20px; }
        .ride-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; margin: 30px 0; }
        .card { background: white; border-radius: 18px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.08); position: relative; }
        .full-ride { filter: grayscale(0.5); opacity: 0.8; }
        .badge-full { position: absolute; top: 10px; right: 10px; background: var(--gray); color: white; padding: 4px 8px; border-radius: 6px; font-size: 0.7em; font-weight: bold; z-index: 5; }

        .btn { padding: 10px 18px; border-radius: 10px; font-weight: 600; text-decoration: none; display: inline-block; cursor: pointer; border: none; font-size: 0.9em; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-wait { background: #e5e5ea; color: #3a3a3c; }
        input { padding: 12px; border: 1px solid #ddd; border-radius: 10px; outline: none; }
    </style>
</head>
<body>
    <div class="nav">
        <div class="container" style="display:flex; justify-content:space-between; align-items:center;">
            <div class="logo-box">
                <div class="car-track"><span class="driving-car">ðŸš—</span></div>
                <strong style="font-size: 1.2em;">Lechelle Covoit</strong>
            </div>
            <div>
                {% if current_user.is_authenticated %}
                    <span style="font-weight:bold;">{{ current_user.name }}{% if current_user.is_admin %} (Admin){% endif %}</span> | 
                    <a href="/my-account">Historique</a> | <a href="/logout">Quitter</a>
                {% else %}
                    <a href="/login">Connexion</a> | <a href="/signup">S'inscrire</a>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="hero">
        <h1>Voyagez ensemble Ã  Lechelle</h1>
        <p>Le covoiturage solidaire, gratuit et sans frais.</p>
    </div>

    <div class="container">
        {% if current_user.is_authenticated %}
        <div style="background:white; padding:25px; border-radius:18px; margin: 30px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
            <h3>Proposer un trajet</h3>
            <form action="/publish" method="post" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(140px, 1fr)); gap:10px;">
                <input name="departure" placeholder="DÃ©part" required>
                <input name="destination" placeholder="Destination" required>
                <input name="contact" placeholder="TÃ©l / WhatsApp" required>
                <input type="date" name="date" required>
                <input type="time" name="time" required>
                <input type="number" name="seats" placeholder="Places" min="1" required>
                <button type="submit" class="btn btn-primary">Publier</button>
            </form>
        </div>
        {% endif %}

        <div class="ride-grid">
            {% for r in rides %}
            <div class="card {{ 'full-ride' if r.seats == 0 else '' }}">
                {% if r.seats == 0 %}<div class="badge-full">COMPLET</div>{% endif %}
                <div id="map_{{ r.id }}" style="height:150px;" data-dep="{{ r.departure }}" data-dest="{{ r.destination }}"></div>
                <div style="padding:15px;">
                    <strong>{{ r.departure }} âž” {{ r.destination }}</strong><br>
                    <small>{{ r.date }} | {{ r.driver_name }}</small>
                    <div style="margin-top:15px; display:flex; justify-content:space-between; align-items:center;">
                        <span>ðŸ’º {{ r.seats }} places</span>
                        <div>
                            {% if current_user.is_authenticated and current_user.id != r.user_id %}
                                <a href="{{ url_for('reserve', ride_id=r.id) }}" class="btn {{ 'btn-primary' if r.seats > 0 else 'btn-wait' }}">
                                    {{ 'RÃ©server' if r.seats > 0 else 'Attente' }}
                                </a>
                            {% endif %}
                            {% if current_user.is_authenticated and (current_user.is_admin or current_user.id == r.user_id) %}
                                <a href="{{ url_for('delete_ride', ride_id=r.id) }}" onclick="return confirm('Archiver ?')" style="color:red; text-decoration:none; margin-left:10px; font-size:1.2em;">ðŸ—‘</a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        async function geocode(city) {
            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)}&limit=1`);
            const data = await res.json();
            return data.length > 0 ? [parseFloat(data[0].lat), parseFloat(data[0].lon)] : null;
        }
        async function init() {
            for (let el of document.querySelectorAll('[id^="map_"]')) {
                const dep = await geocode(el.dataset.dep), dest = await geocode(el.dataset.dest);
                if (dep && dest) {
                    const map = L.map(el.id, {zoomControl: false, attributionControl: false}).setView(dep, 10);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                    L.polyline([dep, dest], {color: '#007aff', weight: 4}).addTo(map);
                }
            }
        }
        window.onload = init;
    </script>
</body>
</html>