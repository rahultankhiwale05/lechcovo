<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Lechelle Covoit</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --accent: #007aff; --bg: #f5f5f7; --gray: #8e8e93; }
        body { margin: 0; font-family: -apple-system, sans-serif; background: var(--bg); color: #1d1d1f; }
        
        .nav { background: white; padding: 15px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 1000; }
        .logo-box { display: flex; align-items: center; gap: 10px; }
        .car-track { position: relative; width: 40px; height: 24px; overflow: hidden; background: #eee; border-radius: 12px; }
        .driving-car { position: absolute; font-size: 1.2rem; animation: driveVanish 3s linear infinite; }
        @keyframes driveVanish { 0% { transform: translateX(40px); } 100% { transform: translateX(-40px); } }

        .hero { 
            background: linear-gradient(rgba(0,122,255,0.7), rgba(0,122,255,0.5)), 
                        url("{{ url_for('static', filename='carte-postale-ancienne-lechelle-20_0.jpg') }}") center/cover; 
            color: white; padding: 60px 20px; text-align: center; border-radius: 0 0 30px 30px; 
        }

        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        
        /* PLACARDS: Guest only */
        .placard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-top: -30px; }
        .placard { background: white; padding: 25px; border-radius: 20px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        
        /* SINGLE LINE FORM */
        .publish-form { background: white; padding: 20px; border-radius: 18px; margin: 30px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .form-row { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
        .form-row input { flex: 1; min-width: 120px; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 0.9em; }

        .ride-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; margin: 30px 0; }
        .card { background: white; border-radius: 18px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.08); position: relative; }
        .badge-full { position: absolute; top: 10px; right: 10px; background: var(--gray); color: white; padding: 4px 8px; border-radius: 6px; font-size: 0.7em; font-weight: bold; z-index: 5; }

        .btn { padding: 10px 20px; border-radius: 8px; font-weight: 600; text-decoration: none; display: inline-block; cursor: pointer; border: none; font-size: 0.9em; }
        .btn-primary { background: var(--accent); color: white; }
    </style>
</head>
<body>
    <div class="nav">
        <div class="container" style="display:flex; justify-content:space-between; align-items:center;">
            <div class="logo-box">
                <div class="car-track"><span class="driving-car">üöó</span></div>
                <strong style="font-size: 1.1em;">Lechelle Covoit</strong>
            </div>
            <div style="font-size: 0.9em;">
                {% if current_user.is_authenticated %}
                    <span style="font-weight:bold;">{{ current_user.name }}</span> | <a href="/my-account">Mon Espace</a> | <a href="/logout">Quitter</a>
                {% else %}
                    <a href="/login">Connexion</a> | <a href="/signup">S'inscrire</a>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="hero">
        <h1 style="margin:0 0 10px 0;">Voyagez ensemble √† Lechelle</h1>
        <p style="margin:0; font-size:0.9em;">Le covoiturage solidaire, gratuit et sans frais.</p>
    </div>

    <div class="container">
        {% if not current_user.is_authenticated %}
        <div class="placard-grid">
            <div class="placard">
                <span style="font-size:1.5rem;">üì±</span>
                <h3 style="margin:10px 0 5px 0;">S'inscrire</h3>
                <p style="color:var(--gray); font-size:0.85em; margin-bottom:15px;">Cr√©ez votre profil pour commencer.</p>
                <a href="/signup" class="btn btn-primary">Rejoindre</a>
            </div>
            <div class="placard">
                <span style="font-size:1.5rem;">üìç</span>
                <h3 style="margin:10px 0 5px 0;">Publiez ou R√©servez</h3>
                <p style="color:var(--gray); font-size:0.85em;">Partagez vos trajets avec vos voisins.</p>
            </div>
        </div>
        {% endif %}

        {% if current_user.is_authenticated %}
        <div class="publish-form">
            <h4 style="margin:0 0 15px 0;">Proposer un trajet</h4>
            <form action="/publish" method="post" class="form-row">
                <input name="departure" placeholder="D√©part" required>
                <input name="destination" placeholder="Destination" required>
                <input name="contact" placeholder="T√©l / WhatsApp" required>
                <input type="date" name="date" required>
                <input type="time" name="time" required>
                <input type="number" name="seats" placeholder="Places" min="1" required>
                <button type="submit" class="btn btn-primary" style="width:120px;">Publier</button>
            </form>
        </div>
        {% endif %}

        <div class="ride-grid">
            {% for r in rides %}
            <div class="card">
                {% if r.seats == 0 %}<div class="badge-full">COMPLET</div>{% endif %}
                <div id="map_{{ r.id }}" style="height:140px;" data-dep="{{ r.departure }}" data-dest="{{ r.destination }}"></div>
                <div style="padding:15px;">
                    <strong>{{ r.departure }} ‚ûî {{ r.destination }}</strong><br>
                    <small style="color:var(--gray);">{{ r.date }} √† {{ r.time }} | Par: {{ r.driver_name }}</small>
                    <div style="margin-top:15px; display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-weight:600;">üí∫ {{ r.seats }} places</span>
                        <div>
                            {% if current_user.is_authenticated and current_user.id != r.user_id %}
                                <a href="{{ url_for('reserve', ride_id=r.id) }}" class="btn btn-primary">{{ 'R√©server' if r.seats > 0 else 'Attente' }}</a>
                            {% endif %}
                            {% if current_user.is_authenticated and (current_user.is_admin or current_user.id == r.user_id) %}
                                <a href="{{ url_for('delete_ride', ride_id=r.id) }}" onclick="return confirm('Archiver ?')" style="color:red; text-decoration:none; margin-left:10px; font-size:1.2em;">üóë</a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        async function geocode(city) {
            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)}&limit=1`);
            const data = await res.json();
            return data.length > 0 ? [parseFloat(data[0].lat), parseFloat(data[0].lon)] : null;
        }
        async function init() {
            for (let el of document.querySelectorAll('[id^="map_"]')) {
                const dep = await geocode(el.dataset.dep), dest = await geocode(el.dataset.dest);
                if (dep && dest) {
                    const map = L.map(el.id, {zoomControl: false, attributionControl: false}).setView(dep, 10);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                    L.polyline([dep, dest], {color: '#007aff', weight: 4}).addTo(map);
                }
            }
        }
        window.onload = init;
    </script>
</body>
</html>